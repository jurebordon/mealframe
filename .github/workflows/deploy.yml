name: Deploy to Homelab

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to Homelab via SSH
    runs-on: ubuntu-latest
    env:
      DEPLOY_DIR: /opt/mealframe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Decode SSH Key
        id: decode_key
        run: |
          DECODED_KEY=$(echo "${{ secrets.HOMELAB_SSH_KEY_BASE64 }}" | base64 -d)
          echo "::add-mask::$DECODED_KEY"
          echo "key_content<<EOF" >> "$GITHUB_OUTPUT"
          echo "$DECODED_KEY" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Deploy to Homelab
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOMELAB_WAN_IP }}
          port: ${{ secrets.HOMELAB_SSH_PORT }}
          username: ${{ secrets.HOMELAB_USERNAME }}
          key: ${{ steps.decode_key.outputs.key_content }}
          script_stop: true
          timeout: 300s
          script: |
            echo "=== Starting MealFrame Deployment ==="
            echo "Connected as: $(whoami)"
            echo "Target directory: ${{ env.DEPLOY_DIR }}"

            cd ${{ env.DEPLOY_DIR }}

            # Run deployment script
            if [ -f "./deploy/deploy.sh" ]; then
              echo "Running deployment script..."
              bash ./deploy/deploy.sh
            else
              echo "Deployment script not found, running inline..."
              git pull origin main
              docker compose -f docker-compose.yml -f docker-compose.npm.yml up -d --build
              docker image prune -f
            fi

            echo "=== Deployment Complete ==="

      - name: Deployment status
        run: |
          echo "âœ… Deployed to homelab via SSH"
          echo "ðŸ”— App available at: https://meals.bordon.family"
